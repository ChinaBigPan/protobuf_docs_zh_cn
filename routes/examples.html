<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>示例 | protobuf.js</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/protobuf_docs_zh_cn/images/favicon.ico">
    <meta name="description" content="protobuf.js 是由 TypeScript 编写的纯 JavaScript 实现 Protocol Buffers 的框架，支持 node.js 和浏览器。">
    <link rel="preload" href="/protobuf_docs_zh_cn/assets/css/0.styles.8864cebc.css" as="style"><link rel="preload" href="/protobuf_docs_zh_cn/assets/js/app.80efe76d.js" as="script"><link rel="preload" href="/protobuf_docs_zh_cn/assets/js/2.c7b6054d.js" as="script"><link rel="preload" href="/protobuf_docs_zh_cn/assets/js/10.08ae5879.js" as="script"><link rel="prefetch" href="/protobuf_docs_zh_cn/assets/js/11.47f965cd.js"><link rel="prefetch" href="/protobuf_docs_zh_cn/assets/js/12.18e8637d.js"><link rel="prefetch" href="/protobuf_docs_zh_cn/assets/js/13.2d1a3f2c.js"><link rel="prefetch" href="/protobuf_docs_zh_cn/assets/js/14.8697807e.js"><link rel="prefetch" href="/protobuf_docs_zh_cn/assets/js/3.bf19f607.js"><link rel="prefetch" href="/protobuf_docs_zh_cn/assets/js/4.7351e2e0.js"><link rel="prefetch" href="/protobuf_docs_zh_cn/assets/js/5.360607c5.js"><link rel="prefetch" href="/protobuf_docs_zh_cn/assets/js/6.3569bd4e.js"><link rel="prefetch" href="/protobuf_docs_zh_cn/assets/js/7.bd2e61a4.js"><link rel="prefetch" href="/protobuf_docs_zh_cn/assets/js/8.f0b9e8aa.js"><link rel="prefetch" href="/protobuf_docs_zh_cn/assets/js/9.8a2d80db.js">
    <link rel="stylesheet" href="/protobuf_docs_zh_cn/assets/css/0.styles.8864cebc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/protobuf_docs_zh_cn/" class="home-link router-link-active"><img src="/protobuf_docs_zh_cn/images/logo.png" alt="protobuf.js" class="logo"> <span class="site-name can-hide">protobuf.js</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="http://www.febeacon.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  大笑文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/protobuf_docs_zh_cn/" class="nav-link">
  文档首页
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="http://www.febeacon.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  大笑文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/protobuf_docs_zh_cn/" class="nav-link">
  文档首页
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/protobuf_docs_zh_cn/routes/" class="sidebar-link">开始</a></li><li><a href="/protobuf_docs_zh_cn/routes/installation.html" class="sidebar-link">安装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/protobuf_docs_zh_cn/routes/installation.html#node-js" class="sidebar-link">Node.js</a></li><li class="sidebar-sub-header"><a href="/protobuf_docs_zh_cn/routes/installation.html#浏览器" class="sidebar-link">浏览器</a></li><li class="sidebar-sub-header"><a href="/protobuf_docs_zh_cn/routes/installation.html#按需加载" class="sidebar-link">按需加载</a></li></ul></li><li><a href="/protobuf_docs_zh_cn/routes/usage.html" class="sidebar-link">使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/protobuf_docs_zh_cn/routes/usage.html#有效信息" class="sidebar-link">有效信息</a></li><li class="sidebar-sub-header"><a href="/protobuf_docs_zh_cn/routes/usage.html#工具箱" class="sidebar-link">工具箱</a></li></ul></li><li><a href="/protobuf_docs_zh_cn/routes/examples.html" class="active sidebar-link">示例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/protobuf_docs_zh_cn/routes/examples.html#使用-proto文件" class="sidebar-link">使用.proto文件</a></li><li class="sidebar-sub-header"><a href="/protobuf_docs_zh_cn/routes/examples.html#使用-json-格式" class="sidebar-link">使用 JSON 格式</a></li><li class="sidebar-sub-header"><a href="/protobuf_docs_zh_cn/routes/examples.html#仅使用反射" class="sidebar-link">仅使用反射</a></li><li class="sidebar-sub-header"><a href="/protobuf_docs_zh_cn/routes/examples.html#使用自定义类" class="sidebar-link">使用自定义类</a></li><li class="sidebar-sub-header"><a href="/protobuf_docs_zh_cn/routes/examples.html#使用服务" class="sidebar-link">使用服务</a></li><li class="sidebar-sub-header"><a href="/protobuf_docs_zh_cn/routes/examples.html#搭配-typescript" class="sidebar-link">搭配 TypeScript</a></li></ul></li><li><a href="/protobuf_docs_zh_cn/routes/command_line.html" class="sidebar-link">命令行</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/protobuf_docs_zh_cn/routes/command_line.html#javascript" class="sidebar-link">JavaScript</a></li><li class="sidebar-sub-header"><a href="/protobuf_docs_zh_cn/routes/command_line.html#typescript" class="sidebar-link">TypeScript</a></li><li class="sidebar-sub-header"><a href="/protobuf_docs_zh_cn/routes/command_line.html#反射与静态代码" class="sidebar-link">反射与静态代码</a></li><li class="sidebar-sub-header"><a href="/protobuf_docs_zh_cn/routes/command_line.html#command-line-api" class="sidebar-link">Command line API</a></li></ul></li><li><a href="/protobuf_docs_zh_cn/routes/performance.html" class="sidebar-link">性能</a></li><li><a href="/protobuf_docs_zh_cn/routes/building.html" class="sidebar-link">构建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/protobuf_docs_zh_cn/routes/building.html#浏览器集成" class="sidebar-link">浏览器集成</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="示例">示例</h1> <p><a href="https://github.com/protobufjs/protobuf.js#examples" target="_blank" rel="noopener noreferrer">英文原地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="使用-proto文件">使用<code>.proto</code>文件</h2> <p>可以使用完整版的库来加载现有的<code>.proto</code>文件，它会解析和编译定义以准备使用(基于反射的)消息类:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// awesome.proto</span>
<span class="token keyword">package</span> awesomepackage<span class="token punctuation">;</span>
syntax <span class="token operator">=</span> <span class="token string">&quot;proto3&quot;</span><span class="token punctuation">;</span>

message AwesomeMessage <span class="token punctuation">{</span>
    string awesome_field <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// becomes awesomeField</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code>protobuf<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">&quot;awesome.proto&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> err<span class="token punctuation">;</span>

    <span class="token comment">// 获得 message 类型</span>
    <span class="token keyword">var</span> AwesomeMessage <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">lookupType</span><span class="token punctuation">(</span><span class="token string">&quot;awesomepackage.AwesomeMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 有效载荷</span>
    <span class="token keyword">var</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span> awesomeField<span class="token punctuation">:</span> <span class="token string">&quot;AwesomeString&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 验证有效负载(如可能不完整或无效)</span>
    <span class="token keyword">var</span> errMsg <span class="token operator">=</span> AwesomeMessage<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建新 message</span>
    <span class="token keyword">var</span> message <span class="token operator">=</span> AwesomeMessage<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 或使用 .fromObject 如果转换是必要的</span>

    <span class="token comment">// 将 message 转换为 Uint8Array (浏览器) 或 Buffer (node)</span>
    <span class="token keyword">var</span> buffer <span class="token operator">=</span> AwesomeMessage<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用 buffer 搞事情...</span>

    <span class="token comment">// 将 Uint8Array (浏览器) 或 Buffer (node) 解码为 message</span>
    <span class="token keyword">var</span> message <span class="token operator">=</span> AwesomeMessage<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用 message 搞事情...</span>

    <span class="token comment">// 如果应用程序使用了长度分隔的 buffer，那么也会有 encodeDelimited 的 buffer 和 decodeDelimited 的 buffer。</span>

    <span class="token comment">// 可以将 message 转换回简单对象</span>
    <span class="token keyword">var</span> object <span class="token operator">=</span> AwesomeMessage<span class="token punctuation">.</span><span class="token function">toObject</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        longs<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
        enums<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
        bytes<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
        <span class="token comment">// 参见 ConversionOptions</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>此外，可以使用期约(Promise)语法来替代回调：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>protobuf<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">&quot;awesome.proto&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="使用-json-格式">使用 JSON 格式</h2> <p>该库利用了与<code>.proto</code>定义相同的 JSON 格式。例如，下面的定义与上面看到的<code>.proto</code>定义相同：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;awesomepackage&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;AwesomeMessage&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;awesomeField&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>JSON 格式非常类似于内部反射结构：</p> <table><thead><tr><th style="text-align:center;">类型(T)</th> <th style="text-align:center;">扩展</th> <th>指定类型的属性</th></tr></thead> <tbody><tr><td style="text-align:center;"><em>ReflectionObject</em></td> <td style="text-align:center;"></td> <td>options</td></tr> <tr><td style="text-align:center;"><em>Namespace</em></td> <td style="text-align:center;"><em>ReflectionObject</em></td> <td>nested</td></tr> <tr><td style="text-align:center;">Root</td> <td style="text-align:center;"><em>Namespace</em></td> <td><strong>nested</strong></td></tr> <tr><td style="text-align:center;">Type</td> <td style="text-align:center;"><em>Namespace</em></td> <td><strong>fields</strong></td></tr> <tr><td style="text-align:center;">Enum</td> <td style="text-align:center;"><em>ReflectionObject</em></td> <td><strong>values</strong></td></tr> <tr><td style="text-align:center;">Field</td> <td style="text-align:center;"><em>ReflectionObject</em></td> <td>rule, <strong>type</strong>, <strong>id</strong></td></tr> <tr><td style="text-align:center;">MapField</td> <td style="text-align:center;">Field</td> <td><strong>keyType</strong></td></tr> <tr><td style="text-align:center;">OneOf</td> <td style="text-align:center;"><em>ReflectionObject</em></td> <td><strong>oneof</strong> (字段名数组)</td></tr> <tr><td style="text-align:center;">Service</td> <td style="text-align:center;"><em>Namespace</em></td> <td><strong>methods</strong></td></tr> <tr><td style="text-align:center;">Method</td> <td style="text-align:center;"><em>ReflectionObject</em></td> <td>type, <strong>requestType</strong>, <strong>responseType</strong>, requestStream, responseStream</td></tr></tbody></table> <ul><li>上表中<strong>加粗的属性</strong>是必需属性，<em>斜体</em>是抽象的。</li> <li><code>T.fromJSON(name, json)</code>根据 JSON 格式创建相应的反射对象。</li> <li><code>T#toJSON()</code>根据相应的反射对象创建 JSON 格式(其名称用作父对象中的键)。</li></ul> <p>如果您只用 JSON 格式而并不使用<code>.proto</code>文件，那么使用<a href="https://github.com/dcodeIO/protobuf.js/tree/master/dist/light" target="_blank" rel="noopener noreferrer">light库<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>即可(本例中不需要解析器)。</p> <p>JSON 文件使用通常方法加载即可：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>protobuf<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">&quot;awesome.json&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>

    <span class="token comment">// 继续上面的&quot;获取信息类型&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>也可以内联加载：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> jsonDescriptor <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./awesome.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// node 示例</span>

<span class="token keyword">var</span> root <span class="token operator">=</span> protobuf<span class="token punctuation">.</span>Root<span class="token punctuation">.</span><span class="token function">fromJSON</span><span class="token punctuation">(</span>jsonDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 继续上面的&quot;获取信息类型&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="仅使用反射">仅使用反射</h2> <p>完全版的库和 light 库都支持反射。举个例子，我们可以仅使用反射来定义上面例子中看到的<code>.proto</code>定义。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token keyword">var</span> Root  <span class="token operator">=</span> protobuf<span class="token punctuation">.</span>Root<span class="token punctuation">,</span>
    Type  <span class="token operator">=</span> protobuf<span class="token punctuation">.</span>Type<span class="token punctuation">,</span>
    Field <span class="token operator">=</span> protobuf<span class="token punctuation">.</span>Field<span class="token punctuation">;</span>

<span class="token keyword">var</span> AwesomeMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">(</span><span class="token string">&quot;AwesomeMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Field</span><span class="token punctuation">(</span><span class="token string">&quot;awesomeField&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;awesomepackage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>AwesomeMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 继续上面的 &quot;创建一个新信息&quot;</span>
<span class="token comment">// ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>有关反射结构的详细信息可以在<a href="https://github.com/protobufjs/protobuf.js#additional-documentation" target="_blank" rel="noopener noreferrer">API文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中找到。</p> <h2 id="使用自定义类">使用自定义类</h2> <p>Message 类也可以扩展自定义功能，还可以注册一个自定义构造函数来反射消息类型:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token comment">// 定义自定义构造器</span>
<span class="token keyword">function</span> <span class="token function">AwesomeMessage</span><span class="token punctuation">(</span><span class="token parameter">properties</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 自定义初始化代码</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用反射类型注册自定义构造器</span>
root<span class="token punctuation">.</span><span class="token function">lookupType</span><span class="token punctuation">(</span><span class="token string">&quot;awesomepackage.AwesomeMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ctor <span class="token operator">=</span> AwesomeMessage<span class="token punctuation">;</span>

<span class="token comment">// 定义自定义函数</span>
AwesomeMessage<span class="token punctuation">.</span><span class="token function-variable function">customStaticMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">AwesomeMessage</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">customInstanceMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 继续上面的 &quot;创建一个新信息&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>(*) 除了通过<code>AwesomeMessage.$type</code>和<code>AwesomeMesage#$type</code>引用其反射类型，相应的自定义类被自动填充为：</p> <ul><li><code>AwesomeMessage.create</code></li> <li><code>AwesomeMessage.encode</code>和<code>AwesomeMessage.encodeDelimited</code></li> <li><code>AwesomeMessage.decode</code>和<code>AwesomeMessage.decodeDelimited</code></li> <li><code>AwesomeMessage.verify</code></li> <li><code>AwesomeMessage.fromObject</code>、<code>AwesomeMessage.toObject</code>和<code>AwesomeMessage#toJSON</code></li></ul> <p>然后，这种类型的解码信息就成为<code>instanceof AwesomeMessage</code></p> <p>或者，如果不需要自定义初始化代码，也可以重用和扩展内部构造函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ...</span>

<span class="token comment">// 重用内部构造函数</span>
<span class="token keyword">var</span> AwesomeMessage <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">lookupType</span><span class="token punctuation">(</span><span class="token string">&quot;awesomepackage.AwesomeMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ctor<span class="token punctuation">;</span>

<span class="token comment">// 定义自定义函数</span>
AwesomeMessage<span class="token punctuation">.</span><span class="token function-variable function">customStaticMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">AwesomeMessage</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">customInstanceMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 继续上面的 &quot;创建一个新信息&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="使用服务">使用服务</h2> <p>该库也支持使用服务但是不对实际的传输通道做任何假设。相反，用户必须提供一个合适的 RPC 实现。该实现是一个异步函数，以反射的服务方法、二进制请求和 node 式回调作为其参数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">rpcImpl</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> requestData<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 例如，使用 HTTP 请求或 WebSocket 执行请求</span>
    <span class="token keyword">var</span> responseData <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span>
    <span class="token comment">// 用二进制响应调用回调</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> responseData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>下面是使用 TypeScript 实现的使用 grpc npm 包的示例：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> grpc <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'grpc'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> Client <span class="token operator">=</span> grpc<span class="token punctuation">.</span><span class="token function">makeGenericClientConstructor</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span>
  grpcServerUrl<span class="token punctuation">,</span>
  grpc<span class="token punctuation">.</span>credentials<span class="token punctuation">.</span><span class="token function">createInsecure</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">rpcImpl</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> requestData<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  client<span class="token punctuation">.</span><span class="token function">makeUnaryRequest</span><span class="token punctuation">(</span>
    method<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    <span class="token parameter">arg</span> <span class="token operator">=&gt;</span> arg<span class="token punctuation">,</span>
    <span class="token parameter">arg</span> <span class="token operator">=&gt;</span> arg<span class="token punctuation">,</span>
    requestData<span class="token punctuation">,</span>
    callback
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// greeter.proto</span>
syntax <span class="token operator">=</span> <span class="token string">&quot;proto3&quot;</span><span class="token punctuation">;</span>

service Greeter <span class="token punctuation">{</span>
    rpc <span class="token function">SayHello</span> <span class="token punctuation">(</span>HelloRequest<span class="token punctuation">)</span> <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">HelloReply</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

message HelloRequest <span class="token punctuation">{</span>
    string name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message HelloReply <span class="token punctuation">{</span>
    string message <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token keyword">var</span> Greeter <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;Greeter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> greeter <span class="token operator">=</span> Greeter<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token comment">/* see above */</span> rpcImpl<span class="token punctuation">,</span> <span class="token comment">/* request delimited? */</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">/* response delimited? */</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

greeter<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'you'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Greeting:'</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>当然也支持期约(promise):</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>greeter<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'you'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Greeting:'</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这里有一个<a href="https://github.com/dcodeIO/protobuf.js/blob/master/examples/streaming-rpc.js" target="_blank" rel="noopener noreferrer">流式 RPC 的示例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>请注意，服务 API 是为客户端设计的。实现一个服务器端接入点几乎总是需要特定的传输通道(如 http, websocket 等)代码，唯一的共同点是它对信息进行解码和编码。</p> <h2 id="搭配-typescript">搭配 TypeScript</h2> <p>该库附带了自己的<a href="https://github.com/dcodeIO/protobuf.js/blob/master/index.d.ts" target="_blank" rel="noopener noreferrer">类型定义文件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，而<a href="https://code.visualstudio.com/" target="_blank" rel="noopener noreferrer">VS Code<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>这样的现代编辑器将自动检测并使用它们来完成代码。</p> <p>由于<code>Buffer</code>的原因，该 npm 包依赖了<a href="https://www.npmjs.com/package/@types/node" target="_blank" rel="noopener noreferrer">@types/node<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，同样因为<code>Long</code>的原因，也依赖了<a href="https://www.npmjs.com/package/@types/long" target="_blank" rel="noopener noreferrer">@types/long<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。如果您并不是为 node 构建或/且不使用<a href="https://github.com/dcodeIO/long.js" target="_blank" rel="noopener noreferrer">long.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，那么建议您手动排除它们。</p> <h3 id="使用-js-api">使用 JS API</h3> <p>上面显示的 API 与 TypeScript 的工作原理基本相同。但是，因为所有内容都是有类型的，所以访问动态生成的<code>message</code>类实例上的字段需要使用括号符号(即<code>message[&quot;awesomeField&quot;]</code>)或显式数据类型转换。另外，也可以使用<a href="https://github.com/protobufjs/protobuf.js#pbts-for-typescript" target="_blank" rel="noopener noreferrer">静态类型文件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> load <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;protobufjs&quot;</span><span class="token punctuation">;</span> <span class="token comment">// respectively &quot;./node_modules/protobufjs&quot;</span>

<span class="token function">load</span><span class="token punctuation">(</span><span class="token string">&quot;awesome.proto&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>

  <span class="token comment">// example code</span>
  <span class="token keyword">const</span> AwesomeMessage <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">lookupType</span><span class="token punctuation">(</span><span class="token string">&quot;awesomepackage.AwesomeMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> message <span class="token operator">=</span> AwesomeMessage<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> awesomeField<span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">message = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> buffer <span class="token operator">=</span> AwesomeMessage<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">buffer = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> decoded <span class="token operator">=</span> AwesomeMessage<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">decoded = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="使用生成的静态代码">使用生成的静态代码</h3> <p>如果您使用 CLI 生成静态代码和类型定义文件到<code>bundlejs</code>和<code>bundle.d.ts</code>，那么您可以做:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> AwesomeMessage <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./bundle.js&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// example code</span>
<span class="token keyword">let</span> message <span class="token operator">=</span> AwesomeMessage<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> awesomeField<span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> buffer  <span class="token operator">=</span> AwesomeMessage<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> decoded <span class="token operator">=</span> AwesomeMessage<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="使用装饰器">使用装饰器</h3> <p>该库还包括了装饰器的早期实现。</p> <p>请注意，装饰器是 TypeScript 的一个实验性特性，声明顺序取决于 JS 目标。举个例子：<code>@Field.d(2, AwesomeArrayMessage)</code>，这意味着<code>AwesomeArrayMessage</code>在之前针对<code>ES5</code>定义过。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Message<span class="token punctuation">,</span> Type<span class="token punctuation">,</span> Field<span class="token punctuation">,</span> OneOf <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;protobufjs/light&quot;</span><span class="token punctuation">;</span> <span class="token comment">// respectively &quot;./node_modules/protobufjs/light.js&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AwesomeSubMessage</span> <span class="token keyword">extends</span> <span class="token class-name">Message</span><span class="token operator">&lt;</span>AwesomeSubMessage<span class="token operator">&gt;</span> <span class="token punctuation">{</span>

  @Field<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> awesomeString<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">enum</span> AwesomeEnum <span class="token punctuation">{</span>
  <span class="token constant">ONE</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token constant">TWO</span> <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

@Type<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;SuperAwesomeMessage&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AwesomeMessage</span> <span class="token keyword">extends</span> <span class="token class-name">Message</span><span class="token operator">&lt;</span>AwesomeMessage<span class="token operator">&gt;</span> <span class="token punctuation">{</span>

  @Field<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;optional&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;awesome default string&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> awesomeField<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  @Field<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> AwesomeSubMessage<span class="token punctuation">)</span>
  <span class="token keyword">public</span> awesomeSubMessage<span class="token punctuation">:</span> AwesomeSubMessage<span class="token punctuation">;</span>

  @Field<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> AwesomeEnum<span class="token punctuation">,</span> <span class="token string">&quot;optional&quot;</span><span class="token punctuation">,</span> AwesomeEnum<span class="token punctuation">.</span><span class="token constant">ONE</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> awesomeEnum<span class="token punctuation">:</span> AwesomeEnum<span class="token punctuation">;</span>

  @OneOf<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;awesomeSubMessage&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;awesomeEnum&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> which<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">// example code</span>
<span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AwesomeMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> awesomeField<span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> buffer  <span class="token operator">=</span> AwesomeMessage<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> decoded <span class="token operator">=</span> AwesomeMessage<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>支持的装饰器包括：</p> <ul><li><p><code>Type.d(typeName?: string)</code> (可选)<br>
将类注释为<code>protobuf</code>信息类型。如果没有指定<code>typeName</code>，则会将构造函数的运行时函数名用于反射类型。</p></li> <li><p><code>Field.d&lt;T&gt;(fieldId: number, fieldType: string | Constructor&lt;T&gt;, fieldRule?: &quot;optional&quot; | &quot;required&quot; | &quot;repeated&quot;, defaultValue?: T)</code>
将属性注释为具有指定<code>id</code>和<code>protobuf</code>类型的<code>protobuf</code>字段。</p></li> <li><p><code>MapField.d&lt;T extends { [key: string]: any }&gt;(fieldId: number, fieldKeyType: string, fieldValueType. string | Constructor&lt;{}&gt;)</code>
将属性注释为具有指定<code>id</code>、<code>protobuf</code>键和值类型的<code>protobuf</code>映射字段。</p></li> <li><p><code>OneOf.d&lt;T extends string&gt;(...fieldNames: string[])</code><br>
将属性注释为覆盖指定字段的<code>protobuf oneof</code>。</p></li></ul> <p>另外：</p> <ul><li>修饰的类型使用平面结构放置在<code>protobuf.roots[&quot;decorated&quot;]</code>中，因此不会有重复的名称。</li> <li><code>Enum</code>会在装饰器求值时被复制到带有泛型名称的反射枚举，因为引用的枚举对象并没有装饰器可以使用的运行时名称。</li> <li>默认值必须指定为装饰器的参数，而不是使用属性初始化来实现正确的原型行为。</li> <li>修饰类上的属性名不能在编译时重命名(例如通过一个小的修饰符)，因为修饰符只接收字符串作为原始字段名。</li></ul> <p>那啥，虽然不太好看，不过在<a href="https://github.com/dcodeIO/protobuf.js/blob/master/examples/js-decorators.js" target="_blank" rel="noopener noreferrer">原生 JavaScript 中使用装饰器<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>也是可以的。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/protobuf_docs_zh_cn/routes/usage.html" class="prev">
        使用
      </a></span> <span class="next"><a href="/protobuf_docs_zh_cn/routes/command_line.html">
        命令行
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/protobuf_docs_zh_cn/assets/js/app.80efe76d.js" defer></script><script src="/protobuf_docs_zh_cn/assets/js/2.c7b6054d.js" defer></script><script src="/protobuf_docs_zh_cn/assets/js/10.08ae5879.js" defer></script>
  </body>
</html>
